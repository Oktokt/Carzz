<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>إدارة المخزون</title>
    <style>
      body { font-family: sans-serif; direction: rtl; padding: 20px; }
      table { border-collapse: collapse; width: 100%; margin-top: 20px; }
      th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
      select, input[type="number"] { padding: 5px; margin: 5px 0; width: 100%; }
      button { padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; }
    </style>
  </head>
  <body>
    <h2>إضافة مخزون جديد</h2>
    <form id="stockForm">
      <label>اختر المنتج:</label>
      <select id="productSelect" required></select>

      <label>الكمية المراد إضافتها:</label>
      <input type="number" id="quantityInput" min="1" required>

      <button type="submit">حفظ</button>
    </form>

    <h2>المخزون الحالي</h2>
    <table id="stockTable">
      <thead>
        <tr><th>المنتج</th><th>الكمية</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      // تحميل البيانات عند الفتح
      window.onload = function() {
        fetchStock();
        fetchProducts();
      };

      function fetchStock() {
        fetch(`https://script.google.com/macros/s/AKfycbzwLzvaMNIpKedYPDU9d-nWOzf35HgehwjS7NCj1z1GIWsJOchHqGsnCWA33xpiS9NR/exec?action=getStock`)
          .then(res => res.json())
          .then(data => {
            const tbody = document.querySelector("#stockTable tbody");
            tbody.innerHTML = "";
            data.stock.forEach(item => {
              const row = `<tr><td>${item.name}</td><td>${item.quantity}</td></tr>`;
              tbody.innerHTML += row;
            });
          });
      }

      function fetchProducts() {
        fetch(`https://script.google.com/macros/s/AKfycbzwLzvaMNIpKedYPDU9d-nWOzf35HgehwjS7NCj1z1GIWsJOchHqGsnCWA33xpiS9NR/exec?action=getProducts`)
          .then(res => res.json())
          .then(data => {
            const select = document.getElementById("productSelect");
            select.innerHTML = "";
            data.products.forEach(p => {
              select.innerHTML += `<option value="${p.name}">${p.name}</option>`;
            });
          });
      }

      // إرسال بيانات الإضافة
      document.getElementById("stockForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const name = document.getElementById("productSelect").value;
        const quantity = document.getElementById("quantityInput").value;

        fetch(`https://script.google.com/macros/s/AKfycbzwLzvaMNIpKedYPDU9d-nWOzf35HgehwjS7NCj1z1GIWsJOchHqGsnCWA33xpiS9NR/exec?action=addStock`, {
          method: "POST",
          body: JSON.stringify({ name, quantity })
        }).then(res => res.json())
          .then(res => {
            if (res.result === "success") {
              location.reload(); // إعادة تحميل الصفحة بعد الحفظ
            } else {
              alert("خطأ: " + res.message);
            }
          });
      });
    </script>
  </body>
</html>
