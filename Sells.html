<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwjJ7cN4eijqkluNFSHEKjuFiGbNGIO3RaBRhOInDpnfsSQyem3LKMWQRKqStbQv19B/exec";
    let products = {};

    async function fetchProducts() {
        try {
            const response = await fetch(scriptURL + "?action=getProducts");
            const data = await response.json();
            const itemSelect = document.getElementById('item');

            data.products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                option.setAttribute('data-price', product.price);
                option.textContent = product.name;
                itemSelect.appendChild(option);
                products[product.name] = product.price;
            });
        } catch (error) {
            console.error("خطأ في جلب المنتجات:", error);
        }
    }

    document.getElementById('item').addEventListener('change', function() {
        const selected = this.value;
        const customerType = document.getElementById('customerType').value;
        if (customerType !== "Owners" && products[selected]) {
            document.getElementById('price').value = products[selected];
        }
        updateTotal();
    });

    document.getElementById('quantity').addEventListener('input', updateTotal);
    document.getElementById('price').addEventListener('input', updateTotal);

    document.getElementById('customerType').addEventListener('change', function() {
        const customerType = this.value;
        const selected = document.getElementById('item').value;
        if (customerType === "Owners") {
            document.getElementById('price').value = 0;
        } else if (products[selected]) {
            document.getElementById('price').value = products[selected];
        }
        updateTotal();
    });

    function updateTotal() {
        const price = parseFloat(document.getElementById('price').value) || 0;
        const quantity = parseInt(document.getElementById('quantity').value) || 0;
        const total = price * quantity;
        document.getElementById('total').value = total.toFixed(2);
    }

    async function submitSale() {
        const item = document.getElementById('item').value;
        const price = parseFloat(document.getElementById('price').value);
        const quantity = parseInt(document.getElementById('quantity').value);
        const notes = document.getElementById('notes').value;
        const customerType = document.getElementById('customerType').value;

        if (!item || isNaN(price) || isNaN(quantity) || !customerType) {
            showMessage("يرجى ملء جميع الحقول المطلوبة", "error");
            return;
        }

        if (!confirm("هل تريد تأكيد البيع؟")) return;

        const payload = {
            item,
            price,
            quantity,
            notes,
            customerType
        };

        try {
            const response = await fetch(scriptURL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.result === "success") {
                showMessage("تم تسجيل البيع بنجاح!", "success");
                document.getElementById('item').value = "";
                document.getElementById('quantity').value = 1;
                document.getElementById('price').value = "";
                document.getElementById('total').value = "";
                document.getElementById('notes').value = "";
                document.getElementById('customerType').value = "";
            } else {
                showMessage("فشل في تسجيل البيع. حاول مرة أخرى.", "error");
            }
        } catch (error) {
            showMessage("خطأ في الاتصال بالسيرفر.", "error");
        }
    }

    function showMessage(msg, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.className = type;
        messageDiv.textContent = msg;
    }

    fetchProducts();
</script>
