<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzCsbGv6SX-TFd-S4WAnBg9vWXpwpFCj6ch8LPmE_SacGTGVNH4cqLeoy6L21G_OZXo/exec";
    let products = {};

    async function fetchProducts() {
        try {
            const response = await fetch(scriptURL + "?action=getItems");
            const data = await response.json();
            
            if (data.error) {
                showMessage(data.error, "error");
                return;
            }

            const itemSelect = document.getElementById('item');
            
            data.products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                option.setAttribute('data-price', product.price);
                option.textContent = product.name;
                itemSelect.appendChild(option);
                products[product.name] = product.price;
            });
        } catch (error) {
            console.error("خطأ في جلب المنتجات:", error);
            showMessage("خطأ في جلب المنتجات.", "error");
        }
    }

    document.getElementById('item').addEventListener('change', function() {
        const selected = this.value;
        if (products[selected]) {
            document.getElementById('price').value = products[selected];
        }
    });

    async function submitSale() {
        const item = document.getElementById('item').value;
        const price = document.getElementById('price').value;
        const notes = document.getElementById('notes').value;
        const customerType = document.getElementById('customerType').value;

        if (!item || !price || !customerType) {
            showMessage("يرجى ملء جميع الحقول المطلوبة", "error");
            return;
        }

        if (!confirm("هل تريد تأكيد البيع؟")) return;

        const payload = {
            item,
            price,
            notes,
            customerType
        };

        try {
            const response = await fetch(scriptURL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.result === "success") {
                showMessage("تم تسجيل البيع بنجاح!", "success");
                document.getElementById('item').value = "";
                document.getElementById('price').value = "";
                document.getElementById('notes').value = "";
                document.getElementById('customerType').value = "";
            } else {
                showMessage("فشل في تسجيل البيع. حاول مرة أخرى.", "error");
            }
        } catch (error) {
            showMessage("خطأ في الاتصال بالسيرفر.", "error");
        }
    }

    function showMessage(msg, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.className = type;
        messageDiv.textContent = msg;
    }

    // تحميل المنتجات عند فتح الصفحة
    fetchProducts();
</script>
