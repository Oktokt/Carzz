<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المبيعات السابقة</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #fff;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            margin-top: 20px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        input[type="date"] {
            padding: 10px;
            margin-bottom: 10px;
        }
        .total {
            font-weight: bold;
            margin-top: 20px;
            color: #FFEB3B;
        }
    </style>
</head>
<body>

    <h1>المبيعات السابقة</h1>

    <label for="dateFilter">تصفية حسب التاريخ:</label>
    <input type="date" id="dateFilter">
    <button onclick="filterSales()">تصفية</button>

    <table id="salesTable">
        <thead>
            <tr>
                <th>التاريخ</th>
                <th>المنتج</th>
                <th>السعر</th>
                <th>الملاحظات</th>
                <th>نوع العميل</th>
            </tr>
        </thead>
        <tbody>
            <!-- المبيعات ستظهر هنا -->
        </tbody>
    </table>

    <div class="total">
        إجمالي المبيعات: <span id="totalSales">0</span> جنيه
    </div>

    <button onclick="exportToCSV()">تصدير إلى CSV</button>
    <button onclick="window.print()">طباعة</button>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbwjJ7cN4eijqkluNFSHEKjuFiGbNGIO3RaBRhOInDpnfsSQyem3LKMWQRKqStbQv19B/exec";

        // جلب المبيعات من جوجل شيت
        async function fetchSales() {
            try {
                const response = await fetch(scriptURL + "?action=getSales");
                const data = await response.json();
                displaySales(data.sales);
            } catch (error) {
                console.error("خطأ في جلب المبيعات:", error);
            }
        }

        // عرض المبيعات في الجدول
        function displaySales(sales) {
            const tableBody = document.querySelector("#salesTable tbody");
            tableBody.innerHTML = "";
            let total = 0;
            sales.forEach(sale => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${sale.date}</td>
                    <td>${sale.item}</td>
                    <td>${sale.price}</td>
                    <td>${sale.notes}</td>
                    <td>${sale.customerType}</td>
                `;
                tableBody.appendChild(row);
                total += parseFloat(sale.price);
            });
            document.getElementById("totalSales").textContent = total;
        }

        // تصفية المبيعات حسب التاريخ
        function filterSales() {
            const filterDate = document.getElementById('dateFilter').value;
            const tableBody = document.querySelector("#salesTable tbody");
            const rows = tableBody.getElementsByTagName('tr');
            let total = 0;

            Array.from(rows).forEach(row => {
                const saleDate = row.cells[0].textContent.split('T')[0];
                if (filterDate && saleDate !== filterDate) {
                    row.style.display = "none";
                } else {
                    row.style.display = "";
                    total += parseFloat(row.cells[2].textContent);
                }
            });

            document.getElementById("totalSales").textContent = total;
        }

        // تصدير البيانات إلى CSV
        function exportToCSV() {
            const table = document.getElementById("salesTable");
            let csvContent = "التاريخ,المنتج,السعر,الملاحظات,نوع العميل\n";
            const rows = table.getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                const cells = row.getElementsByTagName('td');
                if (cells.length > 0) {
                    csvContent += Array.from(cells).map(cell => cell.textContent).join(",") + "\n";
                }
            });

            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
            link.download = 'maby3.csv';
            link.click();
        }

        // تحميل المبيعات عند فتح الصفحة
        fetchSales();
    </script>

</body>
</html>
